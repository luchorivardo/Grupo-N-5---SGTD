@model List<MVC.Models.ViewModels.ProveedorIndexVm>

@{
    ViewData["Title"] = "Proveedores";
}

<link rel="stylesheet" href="~/css/indexBase.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/botones.css" asp-append-version="true" />

<div class="content-container p-3 proveedores-page">
    <!-- Fila superior: filtro + acciones rápidas (opcionales) -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <div class="search-wrapper d-flex align-items-center w-100 w-md-40">
            <label for="q" class="me-2 visually-hidden">Buscar</label>
            <div class="input-group">
                <span class="input-group-text bg-dark border-0" style="color: #dedede; padding: 5px 8px; border-radius: 8px 0 0 8px;">
                    <svg width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M42 42L33.3 33.3M38 22C38 30.8366 30.8366 38 22 38C13.1634 38 6 30.8366 6 22C6 13.1634 13.1634 6 22 6C30.8366 6 38 13.1634 38 22Z" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </span>
                <input id="q" type="text" class="form-control search-input" placeholder="Buscar por código, nombre, proveedor..." />
            </div>
        </div>
    </div>

    <!-- Tabla dentro de un contenedor con scroll -->
    <div class="table-card">
        <div class="table-responsive proveedores-table-wrapper">
            <table class="table proveedores-table index-table mb-0">
                <thead>
                    <tr>
                        <th class="check-col"><input type="checkbox" id="checkAll" /></th>
                        <th>Nombre</th>
                        <th>CUIT</th>
                        <th>Teléfono</th>
                        <th>Correo Electrónico</th>
                        <th>Dirección</th>
                        <th>Provincia</th>
                        <th>Ciudad</th>
                        <th>Rubros</th>
                        <th class="estado-col">Estado</th>
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    @if (Model != null)
                    {
                        foreach (var p in Model)
                        {
                            <tr>
                                <td class="check-col"><input type="checkbox" name="sel" value="@p.Id" /></td>
                                <td>@p.Nombre</td>
                                <td>@p.Cuit</td>
                                <td>@p.Telefono</td>
                                <td>@p.Correo</td> 
                                <td>@p.Direccion</td>
								<td>@p.Provincia</td>
								<td>@p.Ciudad</td>
                                <td>@string.Join(", ", p.RubroNombres)</td>
								<td class="estado-col">
									@if (p.EstadoNombre == "Activo")
									{
                                        <span class="badge estado-activo">Activo</span>
									}
									else
									{
                                        <span class="badge estado-inactivo">Inactivo</span>
									}
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="7" class="text-center text-muted">No hay proveedores</td></tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="actions-row mt-3 d-flex flex-wrap gap-3 justify-content-between sticky-footer">
            <a asp-controller="Proveedores" asp-action="Create" class="btn btn-lg btn-add">AÑADIR PROVEEDOR</a>
            <div class="ms-auto d-flex gap-2">
                <button id="btnModify" class="btn btn-lg btn-edit" disabled>MODIFICAR PROVEEDOR</button>
                <button id="btnDelete" class="btn btn-lg btn-delete" disabled>ELIMINAR PROVEEDOR</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal confirmación eliminación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <form id="deleteForm" asp-controller="Proveedores" asp-action="Delete" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="deleteId" />
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteLabel">Confirmar eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que querés eliminar al proveedor?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Filtro ---
            const qInput = document.getElementById('q');
            if (qInput) {
                qInput.addEventListener('input', function () {
                    const q = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#tabla-body tr');
                    rows.forEach(r => {
                        const text = r.innerText.toLowerCase();
                        r.style.display = text.includes(q) ? '' : 'none';
                    });
                });
            }

            // --- Selección ---
            const checkAll = document.getElementById('checkAll');
            const btnModify = document.getElementById('btnModify');
            const btnDelete = document.getElementById('btnDelete');

            // Siempre que necesitemos las checkboxes de filas, las pedimos de nuevo
            const rowChecks = () => document.querySelectorAll('#tabla-body input[type="checkbox"][name="sel"]');

            // Habilitar / deshabilitar botones según la selección
            function updateButtons() {
                const checks = Array.from(rowChecks());
                const checkedCount = checks.filter(c => c.checked).length;

                btnModify && (btnModify.disabled = checkedCount !== 1);
                btnDelete && (btnDelete.disabled = checkedCount === 0);

                // Estado de checkAll
                if (checkAll) {
                    checkAll.indeterminate = checkedCount > 0 && checkedCount < checks.length;
                    checkAll.checked = checks.length > 0 && checkedCount === checks.length;
                }
            }

            // Marcar / desmarcar todas
            if (checkAll) {
                checkAll.addEventListener('click', () => {
                    const checks = rowChecks();
                    checks.forEach(c => { c.checked = checkAll.checked; });
                    updateButtons();
                });
            }

            // Delegación: cualquier cambio en una checkbox de fila
            document.addEventListener('change', (e) => {
                if (e.target.matches('#tabla-body input[type="checkbox"][name="sel"]')) {
                    updateButtons();
                }
            });

            // Inicial
            updateButtons();

            // --- Modal eliminación ---
            btnDelete?.addEventListener('click', () => {
                const selected = document.querySelector('#tabla-body input[name="sel"]:checked');
                if (selected) {
                    document.getElementById('deleteId').value = selected.value;
                    // Abrir modal usando Bootstrap 5
                    new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
                } else {
                    alert('Seleccioná al menos un proveedor para eliminar.');
                }
            });

            // --- Modificar ---
            btnModify?.addEventListener('click', () => {
                const selected = document.querySelector('#tabla-body input[name="sel"]:checked');
                if (selected) {
                    const id = selected.value;
                    window.location.href = `/Proveedores/Edit/${id}`;
                } else {
                    alert('Seleccioná un proveedor para modificar.');
                }
            });
        });
    </script>
}


