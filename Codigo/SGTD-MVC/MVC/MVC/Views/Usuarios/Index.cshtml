@model IEnumerable<MVC.Models.ViewModels.UsuarioIndexVM>

@{
    ViewData["Title"] = "Usuarios";
}

<link rel="stylesheet" href="~/css/indexBase.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/botones.css" asp-append-version="true" />

<div class="content-container p-3 proveedores-page">
    <!-- Fila superior: filtro + acciones rápidas -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <div class="search-wrapper d-flex align-items-center w-100 w-md-40">
            <label for="q" class="me-2 visually-hidden">Buscar</label>
            <div class="input-group">
                <span class="input-group-text bg-dark border-0" style="color: #dedede; padding: 5px 8px; border-radius: 8px 0 0 8px;">
                    <svg width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M42 42L33.3 33.3M38 22C38 30.8366 30.8366 38 22 38C13.1634 38 6 30.8366 6 22C6 13.1634 13.1634 6 22 6C30.8366 6 38 13.1634 38 22Z" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </span>
                <input id="q" type="text" class="form-control search-input" placeholder="Buscar por nombre, documento, correo..." />
            </div>
        </div>
    </div>

    <!-- Tabla dentro de un contenedor con scroll -->
    <div class="table-card">
        <div class="table-responsive proveedores-table-wrapper">
            <table class="table proveedores-table index-table mb-0">
                <thead>
                    <tr>
                        <th class="check-col"><input type="checkbox" id="checkAll" /></th>
                        <th>Nombre y Apellido</th>
                        <th>Tipo Documento</th>
                        <th>Documento</th>
                        <th>Correo Electronico</th>                        
                        <th>Ciudad</th>
						<th>Provincia</th>
						<th class="rol-col">Rol</th>
                        <th class="estado-col">Estado</th>
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    @if (Model != null)
                    {
                        foreach (var usuario in Model)
                        {
                            <tr>
                                <td class="check-col"><input type="checkbox" name="sel" value="@usuario.Id" /></td>
                                <td>@usuario.Nombre @usuario.Apellido</td>
                                <td>@usuario.TipoDocumento</td>
                                <td>@usuario.NumeroDocumento</td>
                                <td>@usuario.CorreoElectronico</td>
                                <td>@usuario.Ciudad</td>
								<td>@usuario.Provincia</td>
                                <td class="rol-col">
                                    @if (usuario.RolNombre == "Admin")
                                    {
                                        <span class="badge rol-admin">Admin</span>
                                    }
                                    else if (usuario.RolNombre == "Empleado")
                                    {
                                        <span class="badge rol-empleado">Empleado</span>
                                    }
                                    else if (usuario.RolNombre == "Contador")
                                    {
                                        <span class="badge rol-contador">Contador</span>
                                    }
                                    else
                                    {
                                        <span class="badge">@usuario.RolNombre</span>
                                    }
                                </td>
                                <td class="estado-col">
                                    @if (usuario.EstadoNombre == "Activo")
                                    {
                                        <span class="badge estado-activo">Activo</span>
                                    }
                                    else
                                    {
                                        <span class="badge estado-inactivo">Inactivo</span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="7" class="text-center text-muted">No hay usuarios registrados</td></tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="actions-row mt-3 d-flex flex-wrap gap-3 justify-content-between sticky-footer">
            <a asp-controller="Usuarios" asp-action="Create" class="btn btn-lg btn-add">AÑADIR USUARIO</a>
            <div class="ms-auto d-flex gap-2">
                <button id="btnModify" class="btn btn-lg btn-edit" disabled>MODIFICAR USUARIO</button>
                <button id="btnDelete" class="btn btn-lg btn-delete" disabled>ELIMINAR USUARIO</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal confirmación eliminación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <form id="deleteForm" asp-controller="Usuarios" asp-action="Delete" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="deleteId" />
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteLabel">Confirmar eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que querés eliminar al usuario?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const qInput = document.getElementById('q');
            if (qInput) {
                qInput.addEventListener('input', function () {
                    const q = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#tabla-body tr');
                    rows.forEach(r => {
                        const text = r.innerText.toLowerCase();
                        r.style.display = text.includes(q) ? '' : 'none';
                    });
                });
            }

            const checkAll = document.getElementById('checkAll');
            const btnModify = document.getElementById('btnModify');
            const btnDelete = document.getElementById('btnDelete');
            const rowChecks = () => document.querySelectorAll('#tabla-body input[type="checkbox"]');

            if (checkAll && btnModify && btnDelete) {
                document.addEventListener('change', (e) => {
                    if (e.target === checkAll) {
                        rowChecks().forEach(c => c.checked = checkAll.checked);
                    }
                    const checked = Array.from(rowChecks()).filter(c => c.checked).length;
                    btnModify.disabled = checked !== 1;
                    btnDelete.disabled = checked === 0;
                });
            }
            // --- Modal eliminación ---
            btnDelete?.addEventListener('click', () => {
                const selected = document.querySelector('#tabla-body input[name="sel"]:checked');
                if (selected) {
                    document.getElementById('deleteId').value = selected.value;
                    // Abrir modal usando Bootstrap 5
                    new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
                } else {
                    alert('Seleccioná al menos un usuario para eliminar.');
                }
            });
            btnModify?.addEventListener('click', () => {
                const selected = document.querySelector('#tabla-body input[name="sel"]:checked');
                if (selected) {
                    const id = selected.value;
                    window.location.href = `/Usuarios/Edit/${id}`;
                } else {
                    alert('Seleccioná un usuario para modificar.');
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('.search-input');
            const inputGroup = document.querySelector('.input-group');

            if (searchInput && inputGroup) {
                // Cuando el input recibe foco
                searchInput.addEventListener('focus', function() {
                    inputGroup.classList.add('input-group-active');
                });

                // Cuando el input pierde el foco
                searchInput.addEventListener('blur', function() {
                    inputGroup.classList.remove('input-group-active');
                });
            }
        });
        
    </script>
}